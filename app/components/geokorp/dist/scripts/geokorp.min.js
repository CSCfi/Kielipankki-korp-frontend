(function(){"use strict";var a,b={}.hasOwnProperty,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=console,angular.module("sbMap",["leaflet-directive"]).factory("places",["$q","$http",function(b,c){var d;return d=b.defer(),c.get("components/geokorp/dist/data/places.json").success(function(a){return d.resolve({data:a})}).error(function(){return a.log("failed to get place data for sb map"),d.reject()}),d.promise}]).factory("nameMapper",["$q","$http",function(b,c){var d;return d=b.defer(),c.get("components/geokorp/dist/data/name_mapping.json").success(function(a){return d.resolve({data:a})}).error(function(){return a.log("failed to get name mapper for sb map"),d.reject()}),d.promise}]).factory("lbTitles",["$q","$http",function(b,d){var e,f,g;return g=function(a){var b,c,d;if(d=null,c=null,!a||"string"!=typeof a)return null;try{window.DOMParser?(c=new DOMParser,d=c.parseFromString(a,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a))}catch(e){b=e,d="undefined"}return d&&d.documentElement&&!d.getElementsByTagName("parsererror").length||jQuery.error("Invalid XML: "+a),d},f=function(b){var c;return c={method:"GET",params:{username:"app"},transformResponse:function(b,c){var d;return d=g(b),$("fel",d).length&&a.log("xml parse error:",$("fel",d).text()),d}},d(_.merge(c,b))},e=b.defer(),f({url:"http://litteraturbanken.se/query/lb-anthology.xql?action=get-works",headers:{accept:"application/xml"}}).then(function(a){var b,d,f,g,h,i,j,k,l,m,n,o,p,q,r;for(h=a.data,l=[],g=[],q=jQuery(h).find("item"),m=0,o=q.length;o>m;m++){for(f=q[m],j=f.getAttribute("lbworkid"),k=f.getAttribute("shorttitle"),d=[],r=jQuery(f).find("author"),n=0,p=r.length;p>n;n++)b=r[n],d.push(b.getAttribute("fullname"));i=d.join(", "),c.call(g,j)<0&&(g.push(j),l.push({short_title:k,authors:i}))}return e.resolve(l)}),e.promise}]).factory("markers",["$rootScope","$q","$http","places","nameMapper",function(c,d,e,f,g){return function(e){var h,i;return i={type:"div",iconSize:[5,5],html:'<span class="dot"></span>',popupAnchor:[0,0]},h=d.defer(),d.all([f,g]).then(function(d){var f,g,j,k,l,m,n,o,p,q,r,s;for(o=d[0],m=d[1],n=_.keys(e),a.log("Given names: ",n),p=[],k={},g={},r=0,s=n.length;s>r;r++)l=n[r],l.toLowerCase()in m.data?(j=m.data[l.toLowerCase()],f=g[j],f||(f={}),f[l]=e[l],g[j]=f):l.toLowerCase()in o.data&&(f=g[l],f||(f={}),f[l]=e[l],g[l]=f);a.log("locations",g),q=function(a,b){var d,e,f,g,h;return h=o.data[a.toLowerCase()],e=h[0],f=h[1],g=c.$new(!0),g.names=b,d=a.toLowerCase().replace(/-/g,""),k[d]={icon:i,lat:e,lng:f},k[d].getMessageScope=function(){return g}};for(l in g)b.call(g,l)&&(f=g[l],q(l,f));return h.resolve(k)}),h.promise}}]).factory("timeData",["$http","places",function(b,c){var d,e,f,g;return g={},d=1611,f=2015,e=function(a){var b,c,e,g,h,i,j,k,l,m,n,o,p;for(delete a[""],k=function(a,b){var c,d,e,f;switch(f=[null,0,1],e=f[0],d=f[1],c=f[2],a){case"y":e=b;break;case"m":e=b.slice(0,4),d=b.slice(4,6);break;case"d":e=b.slice(0,4),d=b.slice(4,6),c=b.slice(6,8)}return moment([Number(e),Number(d),Number(c)])},b=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;for(b=_.pluck(a,"x"),i=_.min(b,function(a){return a.toDate()}),g=_.max(b,function(a){return a.toDate()}),d=function(){return d=moment.duration({year:1}),c="year"}(),k=moment(g).diff(i,c),j=_.object(_.map(a,function(a){return[moment(a.x).unix(),a.y]})),m=[],e=n=0;k>=0?k>=n:n>=k;e=k>=0?++n:--n)l=moment(i).add(c,e),h=j[l.unix()],"undefined"!=typeof h?f=h:m.push({x:l,y:f});return[].concat(a,m)},c=k("y",d),h=k("y",f.toString()),e=!1,g=!1,j=function(){var b,d,f,j,l;for(f=_.pairs(a),l=[],b=0,d=f.length;d>b;b++)j=f[b],m=j[0],n=j[1],i=k("y",m),i.isSame(c)&&(e=!0),i.isSame(h)&&(g=!0),l.push({x:i,y:n});return l}(),e||j.push({x:c,y:0}),j=b(j),j=j.sort(function(a,b){return a.x.unix()-b.x.unix()}),j.splice(j.length-1,1),o=0,p=j.length;p>o;o++)l=j[o],l.x=l.x.unix();return j},function(d){var f,h,i,j,k,l,m,n;for(h=_.map(d,function(a){return'(word = "'+a.message+'")'}),a.log(h),l=function(a){return"["+a+"]"},f=l(h.join(" | ")),k={command:"count_time",corpus:"LB",cqp:f},j=m=0,n=h.length;n>m;j=++m)i=h[j],k["subcqp"+j]=l(i);return b({method:"GET",url:"http://spraakbanken.gu.se/ws/korp",params:k}).then(function(b){var d,f;return a.log("time response",b.data),f=b.data.combined,delete f[""],d=[],c.then(function(a){var b,c,d,h,i,j,k,l,m,n,o;for(o=[],m=0,n=f.length;n>m;m++)c=f[m],j=e(c.relative),i=c.cqp||"&Sigma;",null!==i.match('"(.*?)"')&&(b=i.match('"(.*?)"')[1],o.push(function(){var c,e,f,i;for(i=[],c=0,e=j.length;e>c;c++)k=j[c],k.y?(l=moment.unix(k.x).year(),null==g[l]&&(g[l]=[]),f=a.data[b.toLowerCase()],d=f[0],h=f[1],i.push(g[moment.unix(k.x).year()].push({val:k.y,name:b,lat:d,lng:h}))):i.push(void 0);return i}()));return o}),g})}}]).factory("geocoder",["$q","places",function(b,c){return function(d){var e;return e=b.defer(),c.then(function(b){var c,f,g,h,i,j,k,l;c=[],i={};for(f in d)k=d[f],j=k.name,j.toLowerCase()in b.data?(l=b.data[j.toLowerCase()],g=l[0],h=l[1],i[f]=angular.extend({lat:g,lng:h},k)):c.push(j);return a.log("geocoder, failed names: ",c),e.resolve({locations:i})}),e.promise}}]).filter("sbDateFilter",function(){return function(a,b,c){var d,e,f;if(f=a||[],c){f={};for(d in a)e=a[d],e.date===b&&(f[d]=e)}return f}}).directive("sbMap",["$compile","$timeout","leafletData","leafletEvents",function(a,b,c,d){var e;return e=function(d,e,f){return d.$on("leafletDirectiveMarker.mouseover",function(c,e){var f,g;return f=e.modelName,g=d.markers[f].getMessageScope(),b(function(){return d.$apply(function(){var b,c;return b=a(d.hoverTemplate),c=b(g),angular.element("#hover-info").empty(),angular.element("#hover-info").append(c),angular.element(".hover-info").css("opacity","1")})},0)}),d.$on("leafletDirectiveMarker.mouseout",function(a){return angular.element(".hover-info").css("opacity","0")}),d.show_map=!1,c.getMap().then(function(a){return L.tileLayer.provider("Stamen.Watercolor").addTo(a),d.show_map=!0})},{restrict:"E",scope:{markers:"=sbMarkers",center:"=sbCenter",showTime:"=sbShowTime",hoverTemplate:"=sbHoverTemplate"},link:e,templateUrl:"components/geokorp/dist/templates/sb_map.html"}}])}).call(this);