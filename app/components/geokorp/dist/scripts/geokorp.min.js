angular.module("sbMapTemplate",["template/sb_map.html"]),angular.module("template/sb_map.html",[]).run(["$templateCache",function(a){a.put("template/sb_map.html",'<div id="sb-map-container" ng-style="{visibility: show_map ? \'visible\' : \'hidden\'}" class="map" >\n    <div id="leaflet-map">\n        <leaflet center="center" markers="markers | sbDateFilter:date:filterEnabled" height="520px"></leaflet>\n    </div>\n    <div id="hover-info">\n\n    </div>\n\n    <!--<div ng-show="showTime">\n        <input type="checkbox" ng-model="filterEnabled"></input>\n        <input type="date" ng-model="date"></input>\n        <div ng-bind="date | date:\'MM/dd/yyyy\'"></div>\n        <div>Filter {{filterEnabled}}</div>\n        <div ng-repeat="m in markers | sbDateFilter:date:filterEnabled">{{m}}</div>\n    </div>-->\n</div>\n\n\n')}]),function(){"use strict";var a,b={}.hasOwnProperty,c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};a=console,angular.module("sbMap",["leaflet-directive","sbMapTemplate"]).factory("places",["$q","$http",function(b,c){var d;return new(d=function(){function d(){this.places=null}return d.prototype.getLocationData=function(){var d;return d=b.defer(),this.places?d.resolve(this.places):c.get("components/geokorp/dist/data/places.json").success(function(a){return function(b){return a.places={data:b},d.resolve(a.places)}}(this)).error(function(b){return function(){return d.reject(),a.log("failed to get place data for sb map")}}(this)),d.promise},d}())}]).factory("nameMapper",["$q","$http",function(b,c){var d;return new(d=function(){function d(){this.mapper=null}return d.prototype.getNameMapper=function(){var d;return d=b.defer(),this.mapper?d.resolve(this.mapper):c.get("components/geokorp/dist/data/name_mapping.json").success(function(a){return d.resolve({data:a})}).error(function(){return a.log("failed to get name mapper for sb map"),d.reject()}),d.promise},d}())}]).factory("lbTitles",["$q","$http",function(b,d){var e,f,g;return g=function(a){var b,c,d;if(d=null,c=null,!a||"string"!=typeof a)return null;try{window.DOMParser?(c=new DOMParser,d=c.parseFromString(a,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(a))}catch(e){b=e,d="undefined"}return d&&d.documentElement&&!d.getElementsByTagName("parsererror").length||jQuery.error("Invalid XML: "+a),d},f=function(b){var c;return c={method:"GET",params:{username:"app"},transformResponse:function(b,c){var d;return d=g(b),$("fel",d).length&&a.log("xml parse error:",$("fel",d).text()),d}},d(_.merge(c,b))},e=b.defer(),f({url:"http://litteraturbanken.se/query/lb-anthology.xql?action=get-works",headers:{accept:"application/xml"}}).then(function(a){var b,d,f,g,h,i,j,k,l,m,n,o,p,q,r;for(h=a.data,l=[],g=[],q=jQuery(h).find("item"),m=0,o=q.length;o>m;m++){for(f=q[m],j=f.getAttribute("lbworkid"),k=f.getAttribute("shorttitle"),d=[],r=jQuery(f).find("author"),n=0,p=r.length;p>n;n++)b=r[n],d.push(b.getAttribute("fullname"));i=d.join(", "),c.call(g,j)<0&&(g.push(j),l.push({short_title:k,authors:i}))}return e.resolve(l)}),e.promise}]).factory("markers",["$rootScope","$q","$http","places","nameMapper",function(a,c,d,e,f){var g;return g={type:"div",iconSize:[5,5],html:'<span class="dot"></span>',popupAnchor:[0,0]},function(d){var h;return h=c.defer(),c.all([e.getLocationData(),f.getNameMapper()]).then(function(c){var e,f,i,j,k,l,m,n,o,p,q,r,s;for(o=c[0],m=c[1],n=_.keys(d),p=[],j={},f={},r=0,s=n.length;s>r;r++)k=n[r],i=null,l=k.toLowerCase(),l in m.data?i=m.data[l]:l in o.data&&(i=l),i&&(e=f[i],e||(e={}),e[k]=d[k],f[i]=e);q=function(b,c){var d,e,f,h,i;return i=o.data[b],e=i[0],f=i[1],h=a.$new(!0),h.names=c,d=b.replace(/-/g,""),j[d]={icon:g,lat:e,lng:f},j[d].getMessageScope=function(){return h}};for(k in f)b.call(f,k)&&(e=f[k],q(k,e));return h.resolve(j)}),h.promise}}]).factory("timeData",["$http","places",function(b,c){var d,e,f,g;return g={},d=1611,f=2015,e=function(a){var b,c,e,g,h,i,j,k,l,m,n,o,p;for(delete a[""],k=function(a,b){var c,d,e,f;switch(f=[null,0,1],e=f[0],d=f[1],c=f[2],a){case"y":e=b;break;case"m":e=b.slice(0,4),d=b.slice(4,6);break;case"d":e=b.slice(0,4),d=b.slice(4,6),c=b.slice(6,8)}return moment([Number(e),Number(d),Number(c)])},b=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;for(b=_.pluck(a,"x"),i=_.min(b,function(a){return a.toDate()}),g=_.max(b,function(a){return a.toDate()}),d=function(){return d=moment.duration({year:1}),c="year"}(),k=moment(g).diff(i,c),j=_.object(_.map(a,function(a){return[moment(a.x).unix(),a.y]})),m=[],e=n=0;k>=0?k>=n:n>=k;e=k>=0?++n:--n)l=moment(i).add(c,e),h=j[l.unix()],"undefined"!=typeof h?f=h:m.push({x:l,y:f});return[].concat(a,m)},c=k("y",d),h=k("y",f.toString()),e=!1,g=!1,j=function(){var b,d,f,j,l;for(f=_.pairs(a),l=[],b=0,d=f.length;d>b;b++)j=f[b],m=j[0],n=j[1],i=k("y",m),i.isSame(c)&&(e=!0),i.isSame(h)&&(g=!0),l.push({x:i,y:n});return l}(),e||j.push({x:c,y:0}),j=b(j),j=j.sort(function(a,b){return a.x.unix()-b.x.unix()}),j.splice(j.length-1,1),o=0,p=j.length;p>o;o++)l=j[o],l.x=l.x.unix();return j},function(d){var f,h,i,j,k,l,m,n;for(h=_.map(d,function(a){return'(word = "'+a.message+'")'}),a.log(h),l=function(a){return"["+a+"]"},f=l(h.join(" | ")),k={command:"count_time",corpus:"LB",cqp:f},j=m=0,n=h.length;n>m;j=++m)i=h[j],k["subcqp"+j]=l(i);return b({method:"GET",url:"http://spraakbanken.gu.se/ws/korp",params:k}).then(function(b){var d,f;return a.log("time response",b.data),f=b.data.combined,delete f[""],d=[],c.then(function(a){var b,c,d,h,i,j,k,l,m,n,o;for(o=[],m=0,n=f.length;n>m;m++)c=f[m],j=e(c.relative),i=c.cqp||"&Sigma;",null!==i.match('"(.*?)"')&&(b=i.match('"(.*?)"')[1],o.push(function(){var c,e,f,i;for(i=[],c=0,e=j.length;e>c;c++)k=j[c],k.y?(l=moment.unix(k.x).year(),null==g[l]&&(g[l]=[]),f=a.data[b.toLowerCase()],d=f[0],h=f[1],i.push(g[moment.unix(k.x).year()].push({val:k.y,name:b,lat:d,lng:h}))):i.push(void 0);return i}()));return o}),g})}}]).filter("sbDateFilter",function(){return function(a,b,c){var d,e,f;if(f=a||[],c){f={};for(d in a)e=a[d],e.date===b&&(f[d]=e)}return f}}).directive("sbMap",["$compile","$timeout","leafletData","leafletEvents",function(a,b,c,d){var e;return e=function(d,e,f){return d.$on("leafletDirectiveMarker.mouseover",function(c,e){var f,g;return f=e.modelName,g=d.markers[f].getMessageScope(),b(function(){return d.$apply(function(){var b,c;return b=a(d.hoverTemplate),c=b(g),angular.element("#hover-info").empty(),angular.element("#hover-info").append(c),angular.element(".hover-info").css("opacity","1")})},0)}),d.$on("leafletDirectiveMarker.mouseout",function(a){return angular.element(".hover-info").css("opacity","0")}),d.show_map=!1,c.getMap().then(function(a){return L.tileLayer.provider("Stamen.Watercolor").addTo(a),d.show_map=!0})},{restrict:"E",scope:{markers:"=sbMarkers",center:"=sbCenter",showTime:"=sbShowTime",hoverTemplate:"=sbHoverTemplate"},link:e,templateUrl:"template/sb_map.html"}}])}.call(this);