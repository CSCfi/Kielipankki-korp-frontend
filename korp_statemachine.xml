<scxml version="1.0" xmlns="http://www.w3.org/2005/07/scxml" 
    profile="ecmascript" initial="init" >
    
    <script><![CDATA[
    
        function kwicSearch() {
            if(In("results_lemgram") || In("results_stats")) {
                $("#result-container li:first > a").trigger("change");
            }
            simpleSearch.resetView();
            kwicProxy.makeRequest();
        }
    
        function lemgramSearch(lemgram, searchPrefix, searchSuffix) {
            $.log("lemgramSearch", lemgram);
            simpleSearch
            .setPlaceholder(util.lemgramToString(lemgram).replace(/<.*?>/g, ""), lemgram)
            .clear();
            lemgramProxy.relationsSearch(lemgram);
            searchProxy.relatedWordSearch(lemgram);
            
            statsProxy.makeRequest(lemgram);
            
            var cqp = lemgramProxy.lemgramSearch(lemgram, searchPrefix, searchSuffix);
            $("#cqp_string").val(cqp);
        }
    ]]></script>
    
<!--     <datamodel> -->
<!--         <data id="kwicProxy"/> -->
<!--         <data id="lemgramProxy"/> -->
<!--         <data id="statsProxy"/> -->
<!--         <data id="simpleSearch"/> -->
<!--         <data id="kwicResults"/> -->
<!--         <data id="lemgramResults"/> -->
<!--         <data id="statsResults"/> -->
    
<!--     </datamodel> -->
    
    <state id="init">
        <transition target="main">
            <assign location="simpleSearch"   expr="new view.SimpleSearch('#korp-simple')"/>
            <assign location="extendedSearch" expr="new view.ExtendedSearch('#korp-extended')"/>
            <assign location="advancedSearch" expr="new view.AdvancedSearch('#korp-advanced')"/>
            <assign location="kwicResults"    expr="new view.KWICResults('#result-container li:first')"/>
            <assign location="lemgramResults" expr="new view.LemgramResults('#result-container li:nth-child(2)')"/>
            <assign location="statsResults"   expr="new view.StatsResults('#result-container li:nth-child(3)')"/>
            
            <assign location="searchProxy"    expr="new model.SearchProxy()"/>
            <assign location="kwicProxy"      expr="new model.KWICProxy()"/>
            <assign location="lemgramProxy"   expr="new model.LemgramProxy()"/>
            <assign location="statsProxy"     expr="new model.StatsProxy()"/>
        </transition>
    </state>
    
    <state id="main" initial="p">
        <onentry>
            <log label="entered main" />
        </onentry>
        
        <parallel id="p" initial="search results sidebar logger">
        
            <state id="search" initial="simple">
                <state id="search_inner"> 
                    
                    
                    <history id="search_history">
                        <onentry>
                            <script>
                                $.log("disabling all result tabs");
                                if($("#result-container").is(".ui-tabs")) 
                                     $("#result-container").tabs("option", "disabled", [0,1,2]);
                            </script>
                        </onentry>
                        <transition target="simple" />
                    </history>
                
                    <transition event="submit.kwic" target="search_history">
                        <script>
                            $("#simple_text").get(0).blur();
                            kwicSearch();
                        </script>
                    </transition>
                    
                    <transition event="searchtab.simple" target="simple" /> 
                    <transition event="searchtab.extended" target="extended" /> 
                    <transition event="searchtab.advanced" target="advanced" /> 
                        
                    <state id="simple">
                        
                        <transition event="submit.lemgram" target="simple">
                            <script>
                                lemgramSearch(_event.data, simpleSearch.isSearchPrefix(), simpleSearch.isSearchSuffix());
                            </script>
                        </transition>
                    
                        <onexit>
                            <script>
                                $("#simple_text").autocomplete("close");
                            </script>
                        </onexit>
                    </state>
                    <state id="extended">
                        <transition event="submit.kwic" target="search_history">
                            <script>
                                advancedSearch.updateCQP();
                                kwicSearch();
                            </script>
                        </transition>
                        <transition event="submit.lemgram" target="search_history">
                            <script>
                                //extendedSearch.setOneToken("lex", _event.data);
                                lemgramSearch(_event.data);
                            </script>
                        </transition>
                    </state>
                    <state id="advanced">
                    
                    </state>
                </state>
            </state>
            
            <state id="results" initial="results_hidden">
            
                <state id="results_hidden">
                    <onentry>
                        <script>
                            $('#results-wrapper').hide();
                        </script>
                    </onentry>
                    <onexit>
                        <script>
                            $('#results-wrapper').fadeIn();
                        </script>
                    </onexit>
                    
                    <transition event="submit" target="results_kwic" cond="($.bbq.getState('result-container', true) || 0) === 0" />
                    <transition event="submit" target="results_lemgram" cond="($.bbq.getState('result-container', true)) === 1" />
                    <transition event="submit" target="results_stats" cond="($.bbq.getState('result-container', true)) === 2" />
                    
                </state>
                
                <state id="results_visible" initial="results_kwic">
                    
                    <transition event="resultstab.kwic" target="results_kwic" /> 
                    <transition event="resultstab.lemgram" target="results_lemgram" /> 
                    <transition event="resultstab.stats" target="results_stats" />
                    
                    <state id="results_kwic" initial="selected_h">
                        <onentry>
                            <script>
                                kwicResults.onentry();
                                util.setJsonLink(kwicProxy.prevRequest);
                            </script>
                        </onentry>
                        
                        <history id="selected_h">
                            <transition target="kwic_word_selected" />
                        </history>
                        
                        <state id="kwic_word_selected">
                            <onentry>
                                <script>
                                    showSidebar();
                                </script>
                            </onentry>
                            <transition event="word.deselect" target="kwic_word_not_selected" />
                            <onexit>
                                <script>
                                    hideSidebar();
                                </script>
                            </onexit>
                        </state>
                        
                        <state id="kwic_word_not_selected">
                            <transition event="word.select" target="kwic_word_selected" />
                        </state>
                        
                        <onexit>
                            <script>
                                kwicResults.onexit();
                            </script>
                        </onexit>
                    </state>
                    <state id="results_lemgram">
                        <onentry>
                            <script>
                                util.setJsonLink(lemgramProxy.prevRequest);
                            </script>
                        </onentry>
                        <transition event="submit.kwic" target="results_lemgram" >
                            <script>
                                $.log("faking kwic result tab click");
                                $("#result-container li:first > a").trigger("change");
                            </script>
                        </transition>
                    </state>
                    <state id="results_stats">
                        <onentry>
                            <script>
                                util.setJsonLink(statsProxy.prevRequest);
                            </script>
                        </onentry>
                        <transition event="submit.kwic" target="results_stats">
                            <script>
                                $("#result-container li:first > a").trigger("change");
                            </script>
                        </transition>
                    </state>
                    
                </state>
            
            </state>
            
            <state id="sidebar" initial="sidebar_hidden">
                <state id="sidebar_hidden">
                    <transition event="sidebar.show" target="sidebar_visible" />
                </state>
                <state id="sidebar_visible">
                    <transition event="sidebar.hide" target="sidebar_hidden" />
                </state>
            </state>
            
            <state id="logger" initial="l2">
                <state id="l2">
                    <transition event="*" target="l2">
                        <log expr="'event found: ' + _event.name" />
                    </transition>
                </state>
            </state>
            
        </parallel>
    </state> 
</scxml> 