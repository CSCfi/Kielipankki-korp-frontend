<scxml version="1.0" xmlns="http://www.w3.org/2005/07/scxml" 
    profile="ecmascript" initial="init" >
    
    <script>
        
    </script>
    
<!--     <datamodel> -->
<!--         <data id="kwicProxy"/> -->
<!--         <data id="lemgramProxy"/> -->
<!--         <data id="statsProxy"/> -->
<!--         <data id="simpleSearch"/> -->
<!--         <data id="kwicResults"/> -->
<!--         <data id="lemgramResults"/> -->
<!--         <data id="statsResults"/> -->
    
<!--     </datamodel> -->
    
    <state id="init">
        <transition target="main">
            <assign location="extendedSearch" expr="new view.ExtendedSearch()"/>
            <assign location="simpleSearch"   expr="new view.SimpleSearch()"/>
            <assign location="kwicResults"    expr="new view.KWICResults('#result-container li:first')"/>
            <assign location="lemgramResults" expr="new view.LemgramResults('#result-container li:nth-child(3)')"/>
            <assign location="statsResults"   expr="new view.StatsResults('#result-container li:nth-child(4)')"/>
            
            <assign location="searchProxy"      expr="new model.SearchProxy()"/>
            <assign location="kwicProxy"      expr="new model.KWICProxy()"/>
            <assign location="lemgramProxy"   expr="new model.LemgramProxy()"/>
            <assign location="statsProxy"     expr="new model.StatsProxy()"/>
        </transition>
    </state>
    
    <state id="main" initial="p">
        <onentry>
            <log label="entered main" />
        </onentry>
        
        <parallel id="p" initial="search results sidebar logger">
        
            <state id="search" initial="simple">
                <state id="search_inner"> 
                
                    <history id="search_history">
                        <transition target="simple" />
                    </history>
                
                    <transition event="submit.kwic" target="search_history">
                        <script>
                            simpleSearch.resetView();
                        </script>
                    </transition>
                    
                    <transition event="searchtab.simple" target="simple" /> 
                    <transition event="searchtab.extended" target="extended" /> 
                    <transition event="searchtab.advanced" target="advanced" /> 
                        
                    <state id="simple">
                        
                        <transition event="submit.lemgram" target="simple">
                            
                        </transition>
                    
                        <onexit>
                            <script>
                                $("#simple_text").autocomplete("close");
                            </script>
                        </onexit>
                    </state>
                    <state id="extended">
                        <transition event="submit.kwic" target="search_history">
                            <script>
                                updateCQP();
                                simpleSearch.resetView();
                            </script>
                        </transition>
                    </state>
                    <state id="advanced">
                    
                    </state>
                </state>
            </state>
            
            <state id="results" initial="results_hidden">
            
                <state id="results_hidden">
                    <onentry>
                        <script>
                            $('#results-wrapper').hide();
                        </script>
                    </onentry>
                    <onexit>
                        <script>
                            $('#results-wrapper').show();
                        </script>
                    </onexit>
                    
                    <transition event="submit" target="results_visible">
                    
                    </transition>
                    
                </state>
                
                <state id="results_visible" initial="results_kwic">
                    
                    <transition event="resultstab.kwic" target="results_kwic" /> 
                    <transition event="resultstab.lemgram" target="results_lemgram" /> 
                    <transition event="resultstab.stats" target="results_stats" />
                    
                    <state id="results_kwic">
                        <onentry>
                            <script>
                                showSidebar();
                                kwicResults.centerScrollbar();
                                setJsonLink(kwicProxy.prevRequest);
                            </script>
                        </onentry>
                        
                        <onexit>
                            <script>
                                hideSidebar();
                            </script>
                        </onexit>
                    </state>
                    <state id="results_lemgram">
                        <onentry>
                            <script>
                                setJsonLink(lemgramProxy.prevRequest);
                            </script>
                        </onentry>
                    </state>
                    <state id="results_stats">
                        <onentry>
                            <script>
                                // TODO: update to correct json link value.
                                setJsonLink(statsProxy.prevRequest);
                            </script>
                        </onentry>
                    </state>
                    
                </state>
            
            </state>
            
            <state id="sidebar" initial="sidebar_hidden">
                <state id="sidebar_hidden">
                    <transition event="sidebar.show" target="sidebar_visible" />
                </state>
                <state id="sidebar_visible">
                    <transition event="sidebar.hide" target="sidebar_hidden" />
                </state>
            </state>
            
            <state id="logger" initial="l2">
                <state id="l2">
                    <transition event="*" target="l2">
                        <log expr="'event found: ' + _event.name" />
                    </transition>
                </state>
            </state>
            
        </parallel>
    </state> 
</scxml> 